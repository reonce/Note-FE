 # ViteçŸ¥è¯†è°ƒç ”

1. Viteå’ŒWebPackçš„åŒºåˆ«ï¼Œå„æœ‰å“ªäº›ä¼˜ç‚¹å’Œä¸è¶³
2. Viteæ‰“åŒ…ä¸ºä»€ä¹ˆå¯ä»¥é‚£ä¹ˆâ€œå¿«â€

1. å°†ç°æœ‰çš„é¡¹ç›®è¿ç§»ä½¿ç”¨Viteå­˜åœ¨å“ªäº›é—®é¢˜
2. Viteç”Ÿäº§ç¯å¢ƒä¸ºä»€ä¹ˆé€‰æ‹©Rollupåšæ„å»ºå·¥å…·

1. ESbuildå’Œbabel-plugin-importç›¸å…³çŸ¥è¯†
2. ViteåŒæœŸç«å“æ¯”è¾ƒ

------

### 1.Viteå’ŒWebpackçš„åŒºåˆ«ï¼Œå„æœ‰å“ªäº›ä¼˜ç‚¹å’Œä¸è¶³

ç°åœ¨å‰ç«¯ä¸»æµçš„æ‰“åŒ…å·¥å…·ä¸»è¦ä»¥ Webpack ä¸ºä»£è¡¨ï¼Œä½†éšç€é¡¹ç›®è§„æ¨¡çš„å‘å±•ï¼Œæ„å»ºæ–¹é¢çš„ç—›ç‚¹è¶Šæ¥è¶Šçªå‡ºï¼Œæœ€å¤§çš„æ„Ÿå—å°±æ˜¯**å¤ªæ…¢äº†**ï¼Œä¸€æ–¹é¢é¡¹ç›®å†·å¯åŠ¨æ—¶å¿…é¡»é€’å½’æ‰“åŒ…æ•´ä¸ªé¡¹ç›®çš„ä¾èµ–æ ‘ï¼Œå¦ä¸€æ–¹é¢ JavaScript è¯­è¨€æœ¬èº«(è§£é‡Šæ‰§è¡Œã€å•çº¿ç¨‹æ‰§è¡Œ)çš„é™åˆ¶ï¼Œå¯¼è‡´æ„å»ºæ€§èƒ½é‡åˆ°ç“¶é¢ˆã€‚

è¿™æ—¶å€™ï¼ŒåŸºäºES moduleçš„ Viteåº”è¿è€Œç”Ÿï¼Œç”±å°¤é›¨æºª(ä»¥ä¸‹ç®€ç§°å°¤è€å¸ˆ)å¸¦é˜Ÿå¼€å‘ã€‚

**åŒºåˆ«**

  webpackæ„å»ºé¡¹ç›®ä¼šå…ˆ**æ‰“åŒ…**ï¼Œä¹‹åå¯åŠ¨æœ¬åœ°å¼€å‘æœåŠ¡å™¨ï¼Œé‡‡ç”¨**å…¨éƒ¨åŠ è½½**çš„æ–¹æ¡ˆï¼Œè¯·æ±‚æ¨¡å—æ—¶åŠ è½½æ¨¡å—ç›¸åº”çš„æ‰“åŒ…ç»“æœã€‚

  viteå¯åŠ¨é¡¹ç›®åˆ™é€‰æ‹©çš„ä¸æ‰“åŒ…çš„æ–¹æ¡ˆï¼Œåœ¨æµè§ˆå™¨è¯·æ±‚æŸä¸ªæ¨¡å—æ—¶ï¼Œæ ¹æ®æ¨¡å—è¿›è¡Œç¼–è¯‘ï¼Œå®ç°**æŒ‰éœ€åŠ¨æ€ç¼–è¯‘**ã€‚

ä»è€Œå¯ä»¥è·³è¿‡æ‰“åŒ…è¿‡ç¨‹ä¸­çš„åˆ†ææ¨¡å—ä¾èµ–ã€ç¼–è¯‘ç­‰æ“ä½œã€‚å½“ç„¶ï¼Œä¸æ˜¯éšä¾¿å°±å¯ä»¥è·³è¿‡æ‰“åŒ…çš„ï¼Œåæ–‡ä¼šæåˆ°ä¸€äº›å…³äºviteè·³è¿‡æ‰“åŒ…è¦å¤„ç†çš„é—®é¢˜ã€‚

  **webpack**ä½œä¸ºè€ç‰Œéœ¸ä¸»ï¼ŒæŠŠå·¥ä½œæ”¾åœ¨äº†æœåŠ¡å™¨ä¸Šï¼Œå…¨éƒ¨ç¼–è¯‘æ‰“åŒ…ï¼Œç»è¿‡å¤šå¹´çš„ä¼˜åŒ–ï¼Œå·²ç»ååˆ†ç¨³å®šã€‚ç¼ºé™·ä¸»è¦æ˜¯æåˆ°çš„é€Ÿåº¦æ…¢ã€‚

  **vite**æ˜¯ä¸€é¢—å¤‡å—ç©ç›®çš„æ–°æ˜Ÿï¼Œä½ å¯èƒ½å¹¶æ²¡æœ‰å¼€å§‹ä½¿ç”¨æˆ–ç ”ç©¶å®ƒï¼Œä½†ä½ ä¸€å®šè€³é—»è¿‡å®ƒã€‚æœ€å¤§çš„ä¼˜åŠ¿æ˜¯é€Ÿåº¦å¿«ã€‚Viteåœ¨ä½¿ç”¨çƒ­æ›´æ–°çš„æ—¶å€™ï¼Œæ”¹åŠ¨ä¸€ä¸ªæ¨¡å—ï¼Œä»…éœ€è®©æµè§ˆå™¨é‡æ–°è¯·æ±‚è¯¥æ¨¡å—å³å¯ï¼Œå› æ­¤æ•ˆç‡æ›´é«˜ã€‚é¡¹ç›®å¤æ‚åº¦è¶Šå¤§ï¼Œviteçš„ä¼˜åŠ¿å°±è¶Šæ˜æ˜¾ã€‚å®ƒç”šè‡³å¯ä»¥æ¯”webpackå¿«åå€ç™¾å€... å®ƒç›®å‰çš„ç¼ºç‚¹æœ‰ï¼š

1. æµè§ˆå™¨å…¼å®¹æ€§ã€‚åªèƒ½ä½¿ç”¨åœ¨ç°ä»£æµè§ˆå™¨ä¸Šï¼ˆæ”¯æŒes2015+ï¼‰
2. æ‰“åŒ…å…¼å®¹æ€§ä¸ç¨³å®šã€‚å¯¹äºCommonJsçš„æ¨¡å—ä¸å®Œå…¨å…¼å®¹

1. å¼€å‘æœåŠ¡å™¨å’Œäº§å“æ„å»ºä¹‹é—´çš„æœ€ä½³è¾“å‡ºå’Œè¡Œä¸ºå­˜åœ¨ä¸ä¸€è‡´çš„æƒ…å†µ
2. ç”Ÿæ€ä¸åŠwebpackï¼Œæ’ä»¶ç­‰ä¸å¤Ÿä¸°å¯Œ

1. ç”Ÿäº§ç¯å¢ƒä¸‹ï¼ŒESbuildæ„å»ºå¯¹äºcssçš„ä»£ç åˆ†å‰²ä¸å¤Ÿå‹å¥½

|         | **æ‰“åŒ…è¿‡ç¨‹**                                                 | **åŸç†**                                                     |
| ------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| webpack | è¯†åˆ«å…¥å£->é€å±‚è¯†åˆ«ä¾èµ–->åˆ†æ/è½¬æ¢/ç¼–è¯‘/è¾“å‡ºä»£ç ->æ‰“åŒ…åçš„ä»£ç  | é€çº§é€’å½’è¯†åˆ«ä¾èµ–ï¼Œæ„å»ºä¾èµ–å›¾è°±->è½¬åŒ–ASTè¯­æ³•æ ‘->å¤„ç†ä»£ç ->è½¬æ¢ä¸ºæµè§ˆå™¨å¯è¯†åˆ«çš„ä»£ç  |
| vite    | -                                                            | åŸºäºæµè§ˆå™¨åŸç”Ÿæ”¯æŒçš„ ES moduleï¼Œåˆ©ç”¨æµè§ˆå™¨è§£æ importsï¼ŒæœåŠ¡å™¨ç«¯æŒ‰éœ€ç¼–è¯‘è¿”å› |

  å€¼å¾—ä¸€æçš„æ˜¯ï¼Œviteåœ¨æ‰“åŒ…éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒçš„æ—¶å€™ï¼Œæ˜¯ä½¿ç”¨**rollup**æ‰“åŒ…çš„ï¼Œåæ–‡ä¼šæåˆ°ä¸€äº›ä¸ºä»€ä¹ˆviteé€‰æ‹©rollupã€‚ä»è¿™ä¸€ç‚¹ä¸Šï¼Œä¸ªäººè®¤ä¸ºviteçš„ä¼˜åŠ¿ä¸»è¦åœ¨**å¼€å‘é˜¶æ®µ**ã€‚

[ä¸ºä»€ä¹ˆç”Ÿäº§ç¯å¢ƒä»éœ€æ‰“åŒ…](https://vitejs.cn/guide/why.html#ä¸ºä»€ä¹ˆç”Ÿäº§ç¯å¢ƒä»éœ€æ‰“åŒ…)

### 2. Viteæ‰“åŒ…ä¸ºä»€ä¹ˆå¯ä»¥é‚£ä¹ˆâ€œå¿«â€

  Viteå¼•ä»¥ä¸ºå‚²çš„æ˜¯å¼€å‘ç¯å¢ƒä¸æ‰“åŒ…ï¼Œå°¤è€å¸ˆåˆ©ç”¨äº†[æµè§ˆå™¨çš„åŸç”Ÿ ES Module æ”¯æŒ](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules)ï¼Œç›´æ¥åœ¨ html æ–‡ä»¶é‡Œå†™è¯¸å¦‚è¿™æ ·çš„ä»£ç ï¼š

// index.html
<div id="app"></div>
<script type="module">
  import { createApp } from 'vue'
  import Main from './Main.vue'
  createApp(Main).mount('#app')
</script>

  Vite ä¼šåœ¨æœ¬åœ°å¸®ä½ å¯åŠ¨ä¸€ä¸ªæœåŠ¡å™¨ï¼Œå½“æµè§ˆå™¨è¯»å–åˆ°è¿™ä¸ª html æ–‡ä»¶ä¹‹åï¼Œä¼šåœ¨æ‰§è¡Œåˆ° import çš„æ—¶å€™æ‰å»å‘æœåŠ¡ç«¯å‘é€æ¨¡å—çš„è¯·æ±‚ï¼Œè§£ææˆæµè§ˆå™¨å¯ä»¥æ‰§è¡Œçš„ js æ–‡ä»¶è¿”å›åˆ°æµè§ˆå™¨ç«¯ã€‚ä¹Ÿå°±æ˜¯è¯´åªæœ‰åœ¨çœŸæ­£ä½¿ç”¨åˆ°è¿™ä¸ªæ¨¡å—çš„æ—¶ï¼Œæµè§ˆå™¨æ‰ä¼šè¯·æ±‚å¹¶ä¸”è§£æè¿™ä¸ªæ¨¡å—ï¼Œæœ€å¤§ç¨‹åº¦çš„åšåˆ°äº†**æŒ‰éœ€åŠ è½½**ã€‚

å¼•ç”¨Vite å®˜ç½‘ä¸Šçš„å›¾ï¼Œä¼ ç»Ÿçš„ bundle æ¨¡å¼æ˜¯è¿™æ ·çš„ï¼š

![img](https://cdn.nlark.com/yuque/0/2021/webp/22685233/1636941361665-3f5b47c6-451e-44dd-b21c-d2e9f9f4230e.webp)

è€ŒåŸºäº ESM çš„æ„å»ºæ¨¡å¼åˆ™æ˜¯è¿™æ ·çš„ï¼š

![img](https://cdn.nlark.com/yuque/0/2021/webp/22685233/1636941361941-62d4eddf-5462-43a5-9a7b-12de2eca4c32.webp)

  ç°è‰²éƒ¨åˆ†æ˜¯æš‚æ—¶æ²¡æœ‰ç”¨åˆ°çš„è·¯ç”±ï¼Œç”šè‡³å®Œå…¨ä¸ä¼šå‚ä¸æ„å»ºè¿‡ç¨‹ï¼Œå³ä½¿é¡¹ç›®ä¸­çš„è·¯ç”±å¢åŠ ï¼Œæ„å»ºé€Ÿåº¦ä¹Ÿä¸ä¼šå˜æ…¢ã€‚

#### ä¾èµ–é¢„ç¼–è¯‘

[ä¾èµ–é¢„ç¼–è¯‘åŸå› ](https://vitejs.cn/guide/dep-pre-bundling.html)

  Vite 2åœ¨ä¸ºç”¨æˆ·å¯åŠ¨å¼€å‘æœåŠ¡å™¨ä¹‹å‰ï¼Œå…ˆç”¨ esbuild æŠŠæ£€æµ‹åˆ°çš„ä¾èµ–é¢„å…ˆæ„å»ºäº†ä¸€éã€‚ä¸€æ–¹é¢ï¼Œå®ƒåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å°†CommonJSä¾èµ–æˆ–UMDä¾èµ–è½¬æ¢æˆESMã€‚å¦ä¸€æ–¹é¢ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œå®ƒå°†å†…éƒ¨æ¨¡å—çš„ä¾èµ–å…³ç³»è½¬æ¢æˆå•ä¸ªæ¨¡å—ï¼Œæé«˜åç»­é¡µé¢åŠ è½½çš„æ€§èƒ½ã€‚ä¾‹å¦‚æˆ‘ä»¬å¯¼å…¥ä¸€ä¸ªlodashçš„åŒ…ï¼Œä½¿ç”¨å®ƒçš„é˜²æŠ–å‡½æ•°ã€‚

import { debounce } from 'lodash' å¯¼å…¥ä¸€ä¸ªå‘½åå‡½æ•°çš„æ—¶å€™ï¼Œdebounce` å‡½æ•°çš„æ¨¡å—å†…éƒ¨åˆä¾èµ–äº†å¾ˆå¤šå…¶ä»–å‡½æ•°ï¼Œå½¢æˆäº†ä¸€ä¸ªä¾èµ–å›¾ã€‚

å½“æµè§ˆå™¨è¯·æ±‚ debounce çš„æ¨¡å—æ—¶ï¼Œåˆä¼šå‘ç°å†…éƒ¨æœ‰ 2 ä¸ª importï¼Œå†è¿™æ ·å»¶ä¼¸ä¸‹å»ï¼Œè¿™ä¸ªå‡½æ•°å†…éƒ¨ç«Ÿç„¶å¸¦æ¥äº† 600 æ¬¡è¯·æ±‚ï¼Œè™½ç„¶æœåŠ¡å™¨å¤„ç†è¿™æ ·è¯·æ±‚æ—¶æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯å¤§é‡çš„è¯·æ±‚ä¼šå¯¼è‡´é¡µé¢çš„åŠ è½½é€Ÿåº¦ç›¸å½“æ…¢ã€‚

![img](https://cdn.nlark.com/yuque/0/2021/webp/22685233/1636941361697-2ae3aff6-8817-40cc-a0ea-bb57defa0665.webp)

  è¿™å¥½å—ï¼Œè¿™ä¸å¥½ã€‚äºæ˜¯å°¤è€å¸ˆæƒ³äº†ä¸ªæŠ˜ä¸­çš„åŠæ³•ï¼Œåˆ©ç”¨ [Esbuild](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fevanw%2Fesbuild) æ¥è¿‘æ— æ•Œçš„æ„å»ºé€Ÿåº¦ï¼Œè®©ä½ åœ¨æ²¡æœ‰æ„ŸçŸ¥çš„æƒ…å†µä¸‹åœ¨å¯åŠ¨çš„æ—¶å€™é¢„å…ˆå¸®ä½ æŠŠ debounce æ‰€ç”¨åˆ°çš„æ‰€æœ‰å†…éƒ¨æ¨¡å—å…¨éƒ¨æ‰“åŒ…æˆä¸€ä¸ªä¼ ç»Ÿçš„ js bundleï¼ˆå¤§æ¦‚ä½œç”¨æ˜¯æŠŠå„ä¸ªæ¨¡å—callä¸€ä¸‹ï¼Œç„¶åå­˜åˆ°ä¸€èµ·ï¼Œæ–¹ä¾¿å…¶ä»–æ¨¡å—è°ƒç”¨ï¼‰ã€‚

[Vite å¯åŠ¨æœåŠ¡å™¨æºç ](https://github.com/vitejs/vite/blob/main/packages/vite/src/node/server/index.ts)

// server/index.ts
const listen = httpServer.listen.bind(httpServer)
httpServer.listen = (async (port: number, ...args: any[]) => {
  try {
   await container.buildStart({})
   // è¿™é‡Œä¼šè¿›è¡Œä¾èµ–çš„é¢„æ„å»º
   await runOptimize()
  } catch (e) {
   httpServer.emit('error', e)
   return
  }
  return listen(port, ...args)
}) as any

  é¦–å…ˆä¼šæ ¹æ®æœ¬æ¬¡è¿è¡Œçš„å…¥å£ï¼Œæ¥æ‰«æå…¶ä¸­çš„ä¾èµ–ï¼š

let deps: Record<string, string>, missing: Record<string, string>
if (!newDeps) {
  ;({ deps, missing } = await scanImports(config))
}

  scanImports å…¶å®å°±æ˜¯åˆ©ç”¨ Esbuild æ„å»ºæ—¶æä¾›çš„é’©å­å»æ‰«ææ–‡ä»¶ä¸­çš„ä¾èµ–ï¼Œæ”¶é›†åˆ° deps å˜é‡é‡Œï¼Œåœ¨æ‰«æåˆ°å…¥å£æ–‡ä»¶ï¼ˆæ¯”å¦‚ index.htmlï¼‰ä¸­ä¾èµ–çš„æ¨¡å—åï¼Œå½¢æˆç±»ä¼¼è¿™æ ·çš„ä¾èµ–è·¯å¾„æ•°æ®ç»“æ„ï¼š

{
  "lodash-es": "node_modules/lodash-es"
}

 ä¹‹åå†æ ¹æ®åˆ†æå‡ºæ¥çš„ä¾èµ–ï¼Œä½¿ç”¨ Esbuild æŠŠå®ƒä»¬æå‰æ‰“åŒ…æˆå•æ–‡ä»¶çš„ bundleã€‚

const esbuildService = await ensureService()
await esbuildService.build({
  entryPoints: Object.keys(flatIdDeps),
  bundle: true,
  format: 'esm',
  external: config.optimizeDeps?.exclude,
  logLevel: 'error',
  splitting: true,
  sourcemap: true
  outdir: cacheDir,
  treeShaking: 'ignore-annotations',
  metafile: esbuildMetaPath,
  define,
  plugins: [esbuildDepPlugin(flatIdDeps, flatIdToExports, config)]
})

  åœ¨æµè§ˆå™¨è¯·æ±‚ç›¸å…³æ¨¡å—æ—¶ï¼Œè¿”å›è¿™ä¸ªé¢„æ„å»ºå¥½çš„æ¨¡å—ã€‚è¿™æ ·ï¼Œå½“æµè§ˆå™¨è¯·æ±‚ lodash-es ä¸­çš„ debounce æ¨¡å—çš„æ—¶å€™ï¼Œå°±å¯ä»¥ä¿è¯åªå‘ç”Ÿä¸€æ¬¡æ¥å£è¯·æ±‚äº†ã€‚

è¿™ä¸€æ­¥å’Œ Webpack æ‰€åšçš„æ„å»ºä¸€æ ·ï¼Œåªä¸è¿‡é€Ÿåº¦å¿«äº†å‡ åå€ã€‚

### 3.å°†ç°æœ‰çš„é¡¹ç›®è¿ç§»ä½¿ç”¨Viteå­˜åœ¨å“ªäº›é—®é¢˜

- *Svgç»„ä»¶æŠ¥é”™*

Vite æš‚æ—¶æ²¡æœ‰å¯¹ svg ç»„ä»¶å†™æ³•çš„æ”¯æŒï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸‹é¢çš„å†™æ³•ä¼šå¯¼è‡´æµè§ˆå™¨æŠ¥é”™:

import Up from 'common/imgs/up.svg';
function Home() {
  return {
   <>
    // çœç•¥å…¶ä»–å­ç»„ä»¶
    <Up className="admin-header-user-up" />
   </>
  }
}

è§£å†³æ–¹æ¡ˆ ï¼š ä½¿ç”¨vite-plugin-react-svgæ’ä»¶, å°†svgæ·»åŠ åˆ°Viteçš„pluginsæ•°ç»„ä¸­ï¼Œå®ç°äº†ä»¥ç»„ä»¶æ–¹å¼å¼•ç”¨ SVG èµ„æºçš„èƒ½åŠ›ã€‚

import Up from 'common/imgs/up.svg?component';

- *ç¬¬ä¸‰æ–¹åŒ…å†…éƒ¨æŠ¥é”™*è§£å†³æ€è·¯ï¼š ä¸€èˆ¬æ¥è¯´ï¼Œè§£å†³ node_modules ä¸­ç¬¬ä¸‰æ–¹åº“çš„ bug å¤§æ¦‚æœ‰ä¸¤ç§æ€è·¯ï¼šç¬¬ä¸€ç§æ€è·¯æ˜¯å°†ç¬¬ä¸‰æ–¹åº“ä¸­æœ‰é—®é¢˜çš„æ–‡ä»¶ copy ä¸€ä»½è¿›è¡Œä¿®å¤ï¼Œæ”¾åœ¨é¡¹ç›®ç›®å½•é‡Œé¢(é node_modules)ï¼Œç„¶åé€šè¿‡æ„å»ºå·¥å…· resolve.alias èƒ½åŠ›**é‡å®šå‘**åˆ°ä¿®å¤åçš„ä½ç½®ã€‚å¦ä¸€ç§æ˜¯é€šè¿‡ patch-package è®°å½• node_modules æ›´æ”¹è®°å½•ï¼Œç”Ÿæˆ patches ç›®å½•ï¼Œç„¶åé€šè¿‡é¡¹ç›®çš„ post-install è„šæœ¬åœ¨å›¢é˜Ÿä¸­åŒæ­¥è¿™ä¸ªæ›´æ”¹ã€‚
- é¢„æ„å»ºåå¤æ‰§è¡ŒVite é¢„æ„å»ºå¹¶ä¸åªæœ‰åœ¨æœåŠ¡å¯åŠ¨çš„æ—¶å€™è¿›è¡Œï¼Œåœ¨è¯·æ±‚è¿›å…¥çš„æ—¶å€™ä¹Ÿæœ‰å¯èƒ½è§¦å‘é¢„æ„å»ºï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ**é¢„æ„å»ºçš„è¡Œä¸ºä¸åªæ˜¯åœ¨æœ€å¼€å§‹è§¦å‘ä¸€æ¬¡ï¼Œåœ¨æµè§ˆå™¨è®¿é—®é¡¹ç›®çš„æ—¶å€™æœ‰å¯èƒ½å†æ¬¡è§¦å‘ï¼Œç”šè‡³æ˜¯å¤šæ¬¡è§¦å‘**ã€‚åœ¨åå¤æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œæ§åˆ¶å°å¯èƒ½ä¼šåå¤æ‰“å°new dependenciesä¹‹ç±»çš„ logï¼Œæ„å»ºç¼“å­˜ç›®å½•ä¼šä¸€æ¬¡æ¬¡åˆ·æ–°ï¼Œç„¶åé¡µé¢å¡ä½ã€‚viteä»“åº“ä¸­ä¹Ÿæœ‰ç›¸å…³çš„issueï¼Œè¿™ç§äºŒæ¬¡é¢„æ„å»ºçš„è¿‡ç¨‹åœ¨æ­£å¸¸çš„é¡¹ç›®ä¸­ä¹Ÿæ˜¯ä¼šçœŸå®å­˜åœ¨çš„ï¼Œä¸»è¦æ˜¯ä¸ºäº†å¤„ç†é¡¹ç›®ä¸­ä¸€äº›åŠ¨æ€ import çš„åœºæ™¯ï¼Œå½“è¿™ç§é€šè¿‡åŠ¨æ€ import çš„ä¾èµ–å¤šäº†ä¹‹åï¼Œä¹Ÿä¼šéå¸¸å½±å“æ„å»ºæ€§èƒ½ï¼Œè¿™ç§åœºæ™¯ä¸‹ä¹Ÿå¯ä»¥ç”¨ **antfu**  å¼€å‘çš„ vite-plugin-optimize-persist è¿™ä¸ªæ’ä»¶è¿›è¡Œè‡ªåŠ¨ä¼˜åŒ–ã€‚

- å¼€å‘ç‰ˆæœ¬å’Œç”Ÿäº§ç‰ˆæœ¬å¯èƒ½å­˜åœ¨å·®å¼‚å¦‚å®˜ç½‘æ‰€è¯´è¦ç¡®ä¿å¼€å‘æœåŠ¡å™¨å’Œäº§å“æ„å»ºä¹‹é—´çš„æœ€ä½³è¾“å‡ºå’Œè¡Œä¸ºä¸€è‡´å¹¶ä¸å®¹æ˜“ï¼Œviteå¯¹æ­¤åšå‡ºäº†å¾ˆå¤šåŠªåŠ›ã€‚å°½ç®¡å°¤è€å¸ˆè¯´å…¶ä»–æ„å»ºå·¥å…·ä¹Ÿä¸æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œä½†ç»è¿‡æ—¶é—´å’Œé¡¹ç›®çš„éªŒè¯ï¼Œwebpackæ˜¾ç„¶æ›´åŠ ç¨³å®šã€‚å¦‚æœå®ƒä¸èƒ½ä¿è¯ä¸¤è€…çš„ä¸€è‡´æ€§ï¼Œé‚£åœ¨ç”¨æˆ·é€‰æ‹©æ—¶ï¼Œå°†ä¼šæˆä¸ºä¸€ä¸ªæ— æ³•å¦¥åçš„é—®é¢˜ã€‚

### 4.Viteç”Ÿäº§ç¯å¢ƒä¸ºä»€ä¹ˆé€‰æ‹©Rollupåšæ„å»ºå·¥å…·

**ä¸€ã€Viteç”Ÿäº§ç¯å¢ƒä¸ºä»€ä¹ˆé€‰æ‹©Rollupåšæ„å»ºå·¥å…·ã€‚**

  Viteæ˜¯ä¸€ä¸ªç”±åŸç”ŸESMé©±åŠ¨çš„Webå¼€å‘æ„å»ºå·¥å…·ã€‚åœ¨é€‰æ‹©æ„å»ºå·¥å…·çš„æ—¶ä¹Ÿæœ€å¥½å¯ä»¥é€‰æ‹©åŸºäºESMçš„å·¥å…·ã€‚

Rollupæ˜¯åŸºäºES2015çš„JavaScriptæ‰“åŒ…å·¥å…·ã€‚å®ƒå°†å°æ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ªå¤§æ–‡ä»¶æˆ–è€…æ›´å¤æ‚çš„åº“å’Œåº”ç”¨ï¼Œæ‰“åŒ…æ—¢å¯ç”¨äºæµè§ˆå™¨å’ŒNode.jsä½¿ç”¨ã€‚ Rollupæœ€æ˜¾è‘—çš„åœ°æ–¹å°±æ˜¯èƒ½è®©æ‰“åŒ…æ–‡ä»¶ä½“ç§¯å¾ˆå°ã€‚ç›¸æ¯”å…¶ä»–JavaScriptæ‰“åŒ…å·¥å…·ï¼ŒRollupæ€»èƒ½æ‰“å‡ºæ›´å°ï¼Œæ›´å¿«çš„åŒ…ã€‚å› ä¸ºRollupåŸºäºES2015æ¨¡å—ï¼Œæ¯”Webpackå’ŒBrowserifyä½¿ç”¨çš„CommonJSæ¨¡å—æœºåˆ¶æ›´é«˜æ•ˆã€‚

**äºŒã€Viteä¸ºä»€ä¹ˆä¸ç”¨Rollupçš„çƒ­æ›´æ–°**

Viteå¼€å‘æ¨¡å¼å•ç‹¬å®ç°äº†ä¸€å¥—çƒ­æ›´æ–°ï¼ˆHMR - Hot Module Replacementï¼‰ï¼Œå¯æ˜¯ä»[Rollup Awesome](https://github.com/rollup/awesome)ä¸­å¯ä»¥å‘ç°ï¼ŒRollupæœ‰çƒ­æ›´æ–°æ’ä»¶[nollup](https://link.zhihu.com/?target=https%3A//github.com/PepsRyuu/nollup)ã€‚ä¸ºä»€ä¹ˆViteä¸ç”¨Rollupçš„çƒ­æ›´æ–°å‘¢ï¼Ÿ

ä»Viteçš„READMEï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼š

Vite was created to tackle native ESM-based HMR. When Vite was first released with working ESM-based HMR, there was no other project actively trying to bring native ESM based HMR to production.

åˆ›å»ºViteæ˜¯ä¸ºäº†è§£å†³åŸºäºesmçš„æœ¬åœ°HMRé—®é¢˜ã€‚ å½“Viteç¬¬ä¸€æ¬¡å‘å¸ƒåŸºäºESMçš„HMRæ—¶ï¼Œè¿˜æ²¡æœ‰å…¶ä»–é¡¹ç›®ç§¯æå°è¯•å°†åŸºäºESMçš„æœ¬åœ°HMRæŠ•å…¥ç”Ÿäº§ã€‚

Viteåœ¨å‘å¸ƒçš„æ—¶å€™è¿˜æ²¡æœ‰å‘ç°åŸºäºçº¯ESMçš„çƒ­æ›´æ–°çš„é¡¹ç›®ï¼Œå½“æ—¶çš„Rollupè¿˜æ²¡æœ‰çº¯ESMçš„çƒ­æ›´æ–°ã€‚å› æ­¤å¯èƒ½æ›´å¤šçš„åŸå› æ˜¯ï¼Œviteå·²ç»è‡ªå·±å†™äº†ï¼Œè€Œä¸æ˜¯Rollupè¿™æ–¹é¢åšçš„ä¸å¤Ÿå¥½ä¹‹ç±»çš„ã€‚

**ä¸‰ã€Viteä¸ºä»€ä¹ˆä¸ç”¨Webpack**

Webpackå’ŒRollupåŠŸèƒ½å·®ä¸å¤šï¼Œä»¥å‰æœ‰ç§è¯´æ³•æ˜¯åº”ç”¨å¼€å‘ç”¨Webpackï¼Œåº“å¼€å‘ç”¨Rollupã€‚ä½†Webpack2.0ä¹‹åä¹Ÿæ”¯æŒäº†Tree shakingï¼ŒRollupä¹Ÿæœ‰çƒ­æ›´æ–°ï¼Œè€Œä¸”éƒ½æœ‰å¼ºå¤§çš„æ’ä»¶å¼€å‘åŠŸèƒ½ã€‚äºŒè€…çš„åŠŸèƒ½å·®å¼‚è¶Šæ¥è¶Šæ¨¡ç³Šã€‚

**äºŒè€…çš„åŒºåˆ«åœ¨å†™æ³•ä¸Šä¹Ÿå¯ä»¥çœ‹å‡ºä¸€äº›ã€‚**

å¦‚ä¸‹æ˜¯Rollupçš„é…ç½®æ–‡ä»¶ï¼š

// rollup.config.js
import babel from 'rollup-plugin-babel';
export default {
   input: './src/index.js',
   output: {
     file: './dist/bundle.rollup.js',
     format: 'cjs'
   },
   plugins: [
     babel({
       presets: [
         [
           'es2015', {
             modules: false
           }
         ]
       ]
     })
   ]
}

ä¸‹é¢æ˜¯webpackçš„é…ç½®æ–‡ä»¶ï¼š

// webpack.config.js
const path = require('path');
const webpack = require('webpack');
module.exports = {
   entry: {
     'index.webpack': path.resolve('./src/index.js')
   },
   output: {
     libraryTarget: "umd",
     filename: "bundle.webpack.js",
   },
   module: {
     rules: [
       {
         test: /\.js$/,
         exclude: /node_modules/,
         loader: 'babel-loader',
         query: {
           presets: ['es2015']
         }
       }
     ]
   }
};

å¯ä»¥çœ‹å‡ºï¼š

- Rollupä½¿ç”¨æ–°çš„ESMï¼Œè€ŒWebpackç”¨çš„æ˜¯æ—§çš„CommonJSã€‚
- Rollupæ”¯æŒç›¸å¯¹è·¯å¾„ï¼Œwebpackéœ€è¦ä½¿ç”¨pathæ¨¡å—ã€‚

Rollupçš„ç”¨æ³•ç›¸å¯¹æ¯”è¾ƒç®€ä¾¿ï¼Œå¯ä»¥æ‰“å‡ºæ›´å°ä½“ç§¯çš„æ–‡ä»¶ï¼Œå¹¶ä¸”ä½¿ç”¨äº†ESMï¼ˆviteä¹Ÿç”¨äº†ESMï¼Œåæ­£ç¼ºç‚¹éƒ½æœ‰äº†ï¼‰ã€‚

åœ¨åŠ ä¸Šå°¤è€å¸ˆå¤šå°‘æœ‰ç‚¹å’ŒwebpackèµŒæ°”çš„æˆåˆ†ï¼Œæ‰€ä»¥Viteé€‰æ‹©äº†Rollupã€‚

### 5.. ESbuildå’Œbabel-plugin-import

  **ESbuild** æ˜¯ä¸€ä¸ªç±»ä¼¼webpackçš„æ„å»ºå·¥å…·ï¼Œå®ƒçš„æ„å»ºé€Ÿåº¦æ˜¯ webpack çš„å‡ åå€ï¼Œç°åœ¨æ¯”è¾ƒç«çš„Viteã€Snowpackç­‰å°±æ˜¯åŸºäºå®ƒå®ç°çš„ã€‚

1. jsæ˜¯å•çº¿ç¨‹ä¸²è¡Œï¼Œesbuildæ˜¯æ–°å¼€ä¸€ä¸ªè¿›ç¨‹ï¼Œç„¶åå¤šçº¿ç¨‹å¹¶è¡Œï¼Œå……åˆ†å‘æŒ¥å¤šæ ¸ä¼˜åŠ¿
2. goæ˜¯çº¯æœºå™¨ç ï¼Œè‚¯å®šè¦æ¯”JITå¿«

1. ä¸ä½¿ç”¨ ASTï¼Œä¼˜åŒ–äº†æ„å»ºæµç¨‹ã€‚ï¼ˆä¹Ÿå¸¦æ¥äº†ä¸€äº›ç¼ºç‚¹ï¼Œåé¢ä¼šè¯´ï¼‰ 

#### ç”¨æ³• 

ç”¨æ³•è¾ƒç¹æ‚ï¼Œæš‚æ—¶ä¸æ˜¯æˆ‘äº†è§£çš„é‡ç‚¹ï¼Œè¿™é‡Œæ”¾ä¸€ä¸ªESbulid ä½¿ç”¨æ–‡æ¡£: [esbuild.github.io/api/](https://link.juejin.cn/?target=https%3A%2F%2Fesbuild.github.io%2Fapi%2F)

#### ç¼ºç‚¹

è¿™é‡Œå…¶å®æˆ‘æœ€æƒ³äº†è§£çš„å°±æ˜¯å®ƒçš„ç¼ºç‚¹ï¼Œå› ä¸ºå®ƒæˆ–å¤šæˆ–å°‘ä¼šå¯¼è‡´æ‰“åŒ…çš„å…¼å®¹æ€§å˜å·®ã€‚

  esbuild ç‰ºç‰²äº†å“ªäº›ä¸œè¥¿ï¼Ÿ ä¸ºäº†ä¿è¯ esbuild çš„ç¼–è¯‘æ•ˆç‡ï¼Œesbuild æ²¡æœ‰æä¾› AST çš„æ“ä½œèƒ½åŠ›ã€‚æ‰€ä»¥ä¸€äº›é€šè¿‡ AST å¤„ç†ä»£ç çš„ babel-plugin æ²¡æœ‰å¾ˆå¥½çš„æ–¹æ³•è¿‡æ¸¡åˆ° esbuild ä¸­ï¼ˆä¾‹å¦‚ babel-plugin-importï¼‰ã€‚å› æ­¤å¦‚æœé¡¹ç›®ä¸­ä½¿ç”¨äº† babel-plugin-import, æˆ–è€…ä¸€äº›è‡ªå®šä¹‰çš„ babel-pluginï¼Œå°±å¯èƒ½å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œç›®å‰æ²¡æœ‰æ¯”è¾ƒå®Œç¾çš„è¿ç§»æ–¹æ¡ˆã€‚

**babel-plugin-import**æ˜¯ä¸€ä¸ªéå¸¸å®ç”¨çš„æ’ä»¶ï¼Œå®ƒå¯ä»¥ä¸ºç»„ä»¶åº“å®ç°å•ç»„ä»¶æŒ‰éœ€åŠ è½½å¹¶ä¸”è‡ªåŠ¨å¼•å…¥å…¶æ ·å¼ã€‚åœ¨äº†è§£å®ƒä¹‹å‰ï¼Œä½ å¯èƒ½éœ€è¦äº†è§£ [ES6æ ‡å‡†å…¥é—¨-Module çš„è¯­æ³•](https://es6.ruanyifeng.com/#docs/module)

å®é™…ä¸Šï¼Œç°åœ¨çš„antç»„ä»¶åº“æä¾›äº†ES Moduleçš„æ„å»ºäº§ç‰©ï¼Œç›´æ¥import {} from 'antd'ä¹Ÿæ˜¯å¯ä»¥è¿›è¡Œtree-shakingçš„ï¼Œä½†ç›¸å…³ç»„ä»¶çš„æ ·å¼æ€ä¹ˆåŠå‘¢ã€‚ä¸‹é¢æ˜¯å¼•å…¥æ ·å¼çš„ç¤ºä¾‹ï¼š

import { Affix, Avatar, Button, Rate } from 'antd';

import 'antd/lib/affix/style';
import 'antd/lib/avatar/style';
import 'antd/lib/button/style';
import 'antd/lib/rate/style';

è¿™å¥½å—ï¼Œè¿™ä¸å¥½ã€‚è¿™æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ç”¨åˆ°babel-plugin-importã€‚å®ƒå¸®æˆ‘ä»¬åšäº†è¿™äº›å·¥ä½œï¼š

import { Button } from 'antd';
  å®ƒå¸®æˆ‘ä»¬å®ç°ğŸ‘‡
var _button = require('antd/lib/button');
require('antd/lib/button/style');

**æ ¸å¿ƒå‚æ•°**ä¸»è¦æ˜¯ä¸‹åˆ—ä¸‰ä¸ªï¼š

{
  "libraryName": "antd",   // åŒ…å
  "libraryDirectory": "lib", // ç›®å½•ï¼Œé»˜è®¤ lib
  "style": true,       // æ˜¯å¦å¼•å…¥ style
}

å…¶ä»–çš„å¯ä»¥çœ‹è¿™é‡Œ => [babel-plugin-importæ–‡æ¡£](https://github.com/ant-design/babel-plugin-import#usage)

babel-plugin-import å’Œæ™®éçš„ babel æ’ä»¶ä¸€æ ·ï¼Œä¼šéå†ä»£ç çš„ astï¼Œç„¶ååœ¨ ast ä¸Šåšäº†ä¸€äº›äº‹æƒ…ï¼š

1. **æ”¶é›†ä¾èµ–**ï¼šæ‰¾åˆ° importDeclarationï¼Œåˆ†æå‡ºåŒ… a å’Œä¾èµ– b,c,d....ï¼Œå‡å¦‚ a å’Œ libraryName ä¸€è‡´ï¼Œå°±å°† b,c,d... åœ¨å†…éƒ¨æ”¶é›†èµ·æ¥
2. **åˆ¤æ–­æ˜¯å¦ä½¿ç”¨**ï¼šåœ¨å¤šç§æƒ…å†µä¸‹ï¼ˆæ¯”å¦‚æ–‡ä¸­æåˆ°çš„ CallExpressionï¼‰åˆ¤æ–­ æ”¶é›†åˆ°çš„ b,c,d... æ˜¯å¦åœ¨ä»£ç ä¸­è¢«ä½¿ç”¨ï¼Œå¦‚æœæœ‰ä½¿ç”¨çš„ï¼Œå°±è°ƒç”¨ importMethod ç”Ÿæˆæ–°çš„ impport è¯­å¥

1. **ç”Ÿæˆå¼•å…¥ä»£ç **ï¼šæ ¹æ®é…ç½®é¡¹ç”Ÿæˆä»£ç å’Œæ ·å¼çš„ import è¯­å¥

å½“ç„¶è¿˜æœ‰å¾ˆå¤šéœ€è¦å¤„ç†çš„ç»†èŠ‚ï¼Œæ¯”å¦‚åˆ é™¤æ—§çš„ import ç­‰ã€‚

é™¤äº† antd å’Œ element ç­‰å¤§å‹ç»„ä»¶åº“ä¹‹å¤–ï¼Œä»»æ„çš„ç»„ä»¶åº“éƒ½å¯ä»¥ä½¿ç”¨ babel-plugin-import æ¥å®ç°æŒ‰éœ€åŠ è½½å’Œè‡ªåŠ¨åŠ è½½æ ·å¼ã€‚

**ä½¿ç”¨çš„å…ˆå†³æ¡ä»¶**

ç”±äºå®ƒçš„ç¼ºç‚¹ï¼Œåœ¨ä½¿ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒä¹‹å‰ï¼Œå¿…é¡»ç¡®ä¿ä»¥ä¸‹ä¸¤æ¡ï¼š

1. æ²¡æœ‰ä½¿ç”¨ä¸€äº›è‡ªå®šä¹‰çš„ babel-plugin (å¦‚ babel-plugin-import)
2. ä¸éœ€è¦å…¼å®¹ä¸€äº›ä½ç‰ˆæœ¬æµè§ˆå™¨ï¼ˆesbuild åªèƒ½å°†ä»£ç è½¬æˆ es6ï¼‰

### 6.ViteåŒæœŸç«å“æ¯”è¾ƒ

å’Œ Vite åŒæ—¶æœŸå‡ºç°çš„ç°ä»£åŒ–æ„å»ºå·¥å…·è¿˜æœ‰ï¼š

- [Snowpack - The faster frontend build tool](https://www.snowpack.dev/)
- [preactjs/wmr: ğŸ‘©â€ğŸš€ The tiny all-in-one development tool for modern web apps.](https://github.com/preactjs/wmr)

- [Web Dev Server: Modern Web](https://modern-web.dev/docs/dev-server/overview/)

**Snowpack** 

Snowpack å’Œ Vite æ¯”è¾ƒç›¸ä¼¼ï¼Œä¹Ÿæ˜¯åŸºäº ESM æ¥å®ç°å¼€å‘ç¯å¢ƒæ¨¡å—åŠ è½½ï¼Œä½†æ˜¯å®ƒçš„æ„å»ºæ—¶å´æ˜¯äº¤ç»™ç”¨æˆ·è‡ªå·±é€‰æ‹©ï¼Œæ•´ä½“çš„æ‰“åŒ…ä½“éªŒæ˜¾å¾—æœ‰ç‚¹æ”¯ç¦»ç ´ç¢ã€‚

è€Œ Vite ç›´æ¥æ•´åˆäº† Rollupï¼Œä¸ºç”¨æˆ·æä¾›äº†å®Œå–„ã€å¼€ç®±å³ç”¨çš„è§£å†³æ–¹æ¡ˆï¼Œå¹¶ä¸”ç”±äºè¿™äº›é›†æˆï¼Œä¹Ÿæ–¹ä¾¿æ‰©å±•æ›´å¤šçš„é«˜çº§åŠŸèƒ½ã€‚

**WMR** 

WMR æ˜¯ä¸º Preactï¼ˆReactæ›¿ä»£æ¡†æ¶ï¼‰ è€Œç”Ÿçš„ï¼Œå¦‚æœä½ åœ¨ä½¿ç”¨ Preactï¼Œå¯ä»¥ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨è¿™ä¸ªå·¥å…·ã€‚

**@web/dev-server**

è¿™ä¸ªå·¥å…·å¹¶æœªæä¾›å¼€ç®±å³ç”¨çš„æ¡†æ¶æ”¯æŒï¼Œä¹Ÿéœ€è¦æ‰‹åŠ¨è®¾ç½® Rollup æ„å»ºé…ç½®ï¼Œä¸è¿‡è¿™ä¸ªé¡¹ç›®é‡ŒåŒ…å«çš„å¾ˆå¤šå·¥å…·ä¹Ÿå¯ä»¥è®© Vite ç”¨æˆ·å—ç›Šã€‚

[Viteå®˜æ–¹æ–‡æ¡£-æ¯”è¾ƒ](https://cn.vitejs.dev/guide/comparisons.html)

## æ€»ç»“

Vite æ˜¯ä¸€ä¸ªé­…åŠ›åè¶³çš„ç°ä»£åŒ–æ„å»ºå·¥å…·ï¼Œå°¤è€å¸ˆä¹Ÿåœ¨å„ä¸ªå¹³å°æ”¾ä¸‹ç‹ è¯ï¼Œè¯´è¦æ›¿ä»£ Webpackï¼Œå¹¶æ€’æ€¼è®¸å¤šviteçš„è´Ÿé¢è¯„è®ºï¼ˆçŸ¥ä¹ï¼‰ã€‚å…¶å® Webpack åœ¨ä¸Šä¸ªä¸–ä»£ä¹Ÿæ˜¯ä¸€ä¸ªè´¡çŒ®éå¸¸å¤§çš„æ„å»ºå·¥å…·ï¼Œåªæ˜¯æ–°ç‰¹æ€§çš„å‡ºç°ï¼Œå‡ºç°äº†å¯ä»¥è§£å†³å®ƒç—›ç‚¹çš„è§£å†³æ–¹æ¡ˆã€‚åœ¨æˆ‘çœ‹æ¥ï¼Œæ¯”è¾ƒç†æƒ³çš„æ–¹æ¡ˆæ˜¯å¼€å‘ç¯å¢ƒä½¿ç”¨viteï¼Œç”Ÿäº§ç¯å¢ƒå¯ä»¥ä½¿ç”¨webpackï¼ˆviteçš„Rollupå¦‚æœä¼˜åŒ–å¤Ÿå¥½ä¹Ÿå¯ä»¥ï¼‰ï¼Œé‡éš¾ç‚¹å°±æ˜¯ä¿è¯å®ƒä»¬çš„ä¸€è‡´æ€§ä»¥åŠæ‰“åŒ…çš„ç¨³å®šæ€§ã€‚



