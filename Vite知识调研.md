## ViteçŸ¥è¯†è°ƒç ”

1. Viteå’ŒWebPackçš„åŒºåˆ«ï¼Œå„æœ‰å“ªäº›ä¼˜ç‚¹å’Œä¸è¶³
2. Viteçš„é€‚ç”¨åœºæ™¯ï¼Œå®é™…ä½¿ç”¨ä¸­å­˜åœ¨å“ªäº›é—®é¢˜
3. Viteæ‰“åŒ…ä¸ºä»€ä¹ˆå¯ä»¥é‚£ä¹ˆâ€œå¿«â€
4. å°†ç°æœ‰çš„é¡¹ç›®è¿ç§»ä½¿ç”¨Viteå­˜åœ¨å“ªäº›é—®é¢˜
5. Viteçš„è½åœ°å‰æ™¯
6. Viteå¸¸è§çš„é…ç½®é¡¹å’Œå…¶ä»–API

---



**1. Viteå’ŒWebPackçš„åŒºåˆ«ï¼Œå„æœ‰å“ªäº›ä¼˜ç‚¹å’Œä¸è¶³**

  ç°åœ¨å‰ç«¯ä¸»æµçš„æ‰“åŒ…å·¥å…·ä¸»è¦ä»¥ Webpack ä¸ºä»£è¡¨ï¼Œä½†éšç€é¡¹ç›®è§„æ¨¡çš„å‘å±•ï¼Œæ„å»ºæ–¹é¢çš„ç—›ç‚¹è¶Šæ¥è¶Šçªå‡ºï¼Œæœ€å¤§çš„æ„Ÿå—å°±æ˜¯**å¤ªæ…¢äº†**ï¼Œä¸€æ–¹é¢é¡¹ç›®å†·å¯åŠ¨æ—¶å¿…é¡»é€’å½’æ‰“åŒ…æ•´ä¸ªé¡¹ç›®çš„ä¾èµ–æ ‘ï¼Œå¦ä¸€æ–¹é¢ JavaScript è¯­è¨€æœ¬èº«(è§£é‡Šæ‰§è¡Œã€å•çº¿ç¨‹æ‰§è¡Œ)çš„é™åˆ¶ï¼Œå¯¼è‡´æ„å»ºæ€§èƒ½é‡åˆ°ç“¶é¢ˆã€‚

  è¿™æ—¶å€™ï¼ŒåŸºäºES moduleçš„ Viteåº”è¿è€Œç”Ÿï¼Œç”±å°¤é›¨æºª(ä»¥ä¸‹ç®€ç§°å°¤å¸ˆ)å¸¦é˜Ÿå¼€å‘ã€‚

**åŒºåˆ«**

  `webpack`æ„å»ºé¡¹ç›®ä¼šå…ˆ**æ‰“åŒ…**ï¼Œä¹‹åå¯åŠ¨æœ¬åœ°å¼€å‘æœåŠ¡å™¨ï¼Œé‡‡ç”¨**å…¨éƒ¨åŠ è½½**çš„æ–¹æ¡ˆï¼Œè¯·æ±‚æ¨¡å—æ—¶åŠ è½½æ¨¡å—ç›¸åº”çš„æ‰“åŒ…ç»“æœã€‚

   `vite`å¯åŠ¨é¡¹ç›®åˆ™é€‰æ‹©çš„ä¸æ‰“åŒ…çš„æ–¹æ¡ˆï¼Œåœ¨æµè§ˆå™¨è¯·æ±‚æŸä¸ªæ¨¡å—æ—¶ï¼Œæ ¹æ®æ¨¡å—è¿›è¡Œç¼–è¯‘ï¼Œå®ç°**æŒ‰éœ€åŠ¨æ€ç¼–è¯‘**ã€‚

ä»è€Œå¯ä»¥è·³è¿‡æ‰“åŒ…è¿‡ç¨‹ä¸­çš„åˆ†ææ¨¡å—ä¾èµ–ã€ç¼–è¯‘ç­‰æ“ä½œã€‚å½“ç„¶ï¼Œä¸æ˜¯éšä¾¿å°±å¯ä»¥è·³è¿‡æ‰“åŒ…çš„ï¼Œåæ–‡ä¼šæåˆ°ä¸€äº›å…³äºviteè·³è¿‡æ‰“åŒ…è¦å¤„ç†çš„é—®é¢˜ã€‚

â€‹	**webpack**ä½œä¸ºè€ç‰Œéœ¸ä¸»ï¼ŒæŠŠå·¥ä½œæ”¾åœ¨äº†æœåŠ¡å™¨ä¸Šï¼Œå…¨éƒ¨ç¼–è¯‘æ‰“åŒ…ï¼Œç»è¿‡å¤šå¹´çš„ä¼˜åŒ–ï¼Œå·²ç»ååˆ†ç¨³å®šã€‚ç¼ºé™·ä¸»è¦æ˜¯æåˆ°çš„é€Ÿåº¦æ…¢ã€‚

  **vite**æ˜¯ä¸€é¢—å¤‡å—ç©ç›®çš„æ–°æ˜Ÿï¼Œä½ å¯èƒ½å¹¶æ²¡æœ‰å¼€å§‹ä½¿ç”¨æˆ–ç ”ç©¶å®ƒï¼Œä½†ä½ ä¸€å®šè€³é—»è¿‡å®ƒã€‚æœ€å¤§çš„ä¼˜åŠ¿æ˜¯é€Ÿåº¦å¿«ã€‚é¡¹ç›®å¤æ‚åº¦è¶Šå¤§ï¼Œviteçš„ä¼˜åŠ¿å°±è¶Šæ˜æ˜¾ã€‚å®ƒç”šè‡³å¯ä»¥æ¯”webpackå¿«åå€ç™¾å€...  å®ƒç›®å‰çš„ç¼ºç‚¹æœ‰ï¼š

1. æµè§ˆå™¨å…¼å®¹æ€§ã€‚åªèƒ½ä½¿ç”¨åœ¨ç°ä»£æµè§ˆå™¨ä¸Šï¼ˆæ”¯æŒes2015+ï¼‰
2. æ‰“åŒ…å…¼å®¹æ€§ä¸ç¨³å®šã€‚å¯¹äºCommonJsçš„æ¨¡å—ä¸å®Œå…¨å…¼å®¹
3. å¼€å‘æœåŠ¡å™¨å’Œäº§å“æ„å»ºä¹‹é—´çš„æœ€ä½³è¾“å‡ºå’Œè¡Œä¸ºå­˜åœ¨ä¸ä¸€è‡´çš„æƒ…å†µ
4. ç”Ÿæ€ä¸åŠwebpackï¼Œæ’ä»¶ç­‰ä¸å¤Ÿä¸°å¯Œ
5. ç”Ÿäº§ç¯å¢ƒä¸‹ï¼ŒESbuildæ„å»ºå¯¹äºcssçš„ä»£ç åˆ†å‰²ä¸å¤Ÿå‹å¥½

|         |                         **æ‰“åŒ…è¿‡ç¨‹**                         |                             åŸç†                             |
| ------- | :----------------------------------------------------------: | :----------------------------------------------------------: |
| webpack | è¯†åˆ«å…¥å£->é€å±‚è¯†åˆ«ä¾èµ–->åˆ†æ/è½¬æ¢/ç¼–è¯‘/è¾“å‡ºä»£ç ->æ‰“åŒ…åçš„ä»£ç  | é€çº§é€’å½’è¯†åˆ«ä¾èµ–ï¼Œæ„å»ºä¾èµ–å›¾è°±->è½¬åŒ–ASTè¯­æ³•æ ‘->å¤„ç†ä»£ç ->è½¬æ¢ä¸ºæµè§ˆå™¨å¯è¯†åˆ«çš„ä»£ç  |
| vite    |                              -                               | åŸºäºæµè§ˆå™¨åŸç”Ÿæ”¯æŒçš„ ES moduleï¼Œåˆ©ç”¨æµè§ˆå™¨è§£æ importsï¼ŒæœåŠ¡å™¨ç«¯æŒ‰éœ€ç¼–è¯‘è¿”å› |

å‚è€ƒ

https://blog.51cto.com/xuedingmaojun/2967713

https://juejin.cn/post/7005731645911203877

**3. Viteæ‰“åŒ…ä¸ºä»€ä¹ˆå¯ä»¥é‚£ä¹ˆâ€œå¿«â€**

Viteå¼•ä»¥ä¸ºå‚²çš„æ˜¯å¼€å‘ç¯å¢ƒä¸æ‰“åŒ…ï¼Œå°¤å¸ˆåˆ©ç”¨äº†[æµè§ˆå™¨çš„åŸç”Ÿ ES Module æ”¯æŒ](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules)ï¼Œç›´æ¥åœ¨ html æ–‡ä»¶é‡Œå†™è¯¸å¦‚è¿™æ ·çš„ä»£ç ï¼š

```html
// index.html
<div id="app"></div>
<script type="module">
  import { createApp } from 'vue'
  import Main from './Main.vue'
  createApp(Main).mount('#app')
</script>
å¤åˆ¶ä»£ç 
```

 Vite ä¼šåœ¨æœ¬åœ°å¸®ä½ å¯åŠ¨ä¸€ä¸ªæœåŠ¡å™¨ï¼Œå½“æµè§ˆå™¨è¯»å–åˆ°è¿™ä¸ª html æ–‡ä»¶ä¹‹åï¼Œä¼šåœ¨æ‰§è¡Œåˆ° import çš„æ—¶å€™æ‰å»å‘æœåŠ¡ç«¯å‘é€æ¨¡å—çš„è¯·æ±‚ï¼Œè§£ææˆæµè§ˆå™¨å¯ä»¥æ‰§è¡Œçš„ js æ–‡ä»¶è¿”å›åˆ°æµè§ˆå™¨ç«¯ã€‚ä¹Ÿå°±æ˜¯è¯´åªæœ‰åœ¨çœŸæ­£ä½¿ç”¨åˆ°è¿™ä¸ªæ¨¡å—çš„æ—¶ï¼Œæµè§ˆå™¨æ‰ä¼šè¯·æ±‚å¹¶ä¸”è§£æè¿™ä¸ªæ¨¡å—ï¼Œæœ€å¤§ç¨‹åº¦çš„åšåˆ°äº†**æŒ‰éœ€åŠ è½½**ã€‚

å¼•ç”¨Vite å®˜ç½‘ä¸Šçš„å›¾ï¼Œä¼ ç»Ÿçš„ bundle æ¨¡å¼æ˜¯è¿™æ ·çš„ï¼š

![ä¼ ç»Ÿ bundle](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e1c187722cd9405687c6c0ff40b54b9b~tplv-k3u1fbpfcp-watermark.awebp)

è€ŒåŸºäº ESM çš„æ„å»ºæ¨¡å¼åˆ™æ˜¯è¿™æ ·çš„ï¼š

![åŸºäº ESM](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/af2907c55cdb4fedadf8e604907ddc57~tplv-k3u1fbpfcp-watermark.awebp)

ç°è‰²éƒ¨åˆ†æ˜¯æš‚æ—¶æ²¡æœ‰ç”¨åˆ°çš„è·¯ç”±ï¼Œç”šè‡³å®Œå…¨ä¸ä¼šå‚ä¸æ„å»ºè¿‡ç¨‹ï¼Œå³ä½¿é¡¹ç›®ä¸­çš„è·¯ç”±å¢åŠ ï¼Œæ„å»ºé€Ÿåº¦ä¹Ÿä¸ä¼šå˜æ…¢ã€‚

## ä¾èµ–é¢„ç¼–è¯‘

[ä¾èµ–é¢„ç¼–è¯‘åŸå› ](https://vitejs.cn/guide/dep-pre-bundling.html)ï¼Œå…¶å®æ˜¯ Vite 2.0 åœ¨ä¸ºç”¨æˆ·å¯åŠ¨å¼€å‘æœåŠ¡å™¨ä¹‹å‰ï¼Œå…ˆç”¨ `esbuild` æŠŠæ£€æµ‹åˆ°çš„ä¾èµ–é¢„å…ˆæ„å»ºäº†ä¸€éã€‚ä¾èµ–é¢„ç¼–è¯‘åŸå›    

ä¹Ÿè®¸ä½ ä¼šç–‘æƒ‘ï¼Œä¸æ˜¯ä¸€ç›´è¯´å¥½çš„ no-bundle å—ï¼Œæ€ä¹ˆè¿˜æ˜¯èµ°å¯åŠ¨æ—¶ç¼–è¯‘è¿™æ¡è·¯çº¿äº†ï¼Ÿå°¤å¸ˆè¿™ä¹ˆåšå½“ç„¶æ˜¯æœ‰ç†ç”±çš„ï¼Œæˆ‘ä»¬å…ˆä»¥å¯¼å…¥ `lodash-es` è¿™ä¸ªåŒ…ä¸ºä¾‹ã€‚

å½“ä½ ç”¨ `import { debounce } from 'lodash'` å¯¼å…¥ä¸€ä¸ªå‘½åå‡½æ•°çš„æ—¶å€™ï¼Œå¯èƒ½ä½ ç†æƒ³ä¸­çš„åœºæ™¯å°±æ˜¯æµè§ˆå™¨å»ä¸‹è½½åªåŒ…å«è¿™ä¸ªå‡½æ•°çš„æ–‡ä»¶ã€‚ä½†å…¶å®æ²¡é‚£ä¹ˆç†æƒ³ï¼Œ`debounce` å‡½æ•°çš„æ¨¡å—å†…éƒ¨åˆä¾èµ–äº†å¾ˆå¤šå…¶ä»–å‡½æ•°ï¼Œå½¢æˆäº†ä¸€ä¸ªä¾èµ–å›¾ã€‚

å½“æµè§ˆå™¨è¯·æ±‚ `debounce` çš„æ¨¡å—æ—¶ï¼Œåˆä¼šå‘ç°å†…éƒ¨æœ‰ 2 ä¸ª `import`ï¼Œå†è¿™æ ·å»¶ä¼¸ä¸‹å»ï¼Œè¿™ä¸ªå‡½æ•°å†…éƒ¨ç«Ÿç„¶å¸¦æ¥äº† 600 æ¬¡è¯·æ±‚ï¼Œè€—æ—¶ä¼šåœ¨ 1s å·¦å³ã€‚

![lodash è¯·æ±‚ä¾èµ–é“¾è·¯](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d9273fbf819c430ea0a44677c789cf6b~tplv-k3u1fbpfcp-watermark.awebp)

è¿™å½“ç„¶æ˜¯ä¸å¯æ¥å—çš„ï¼Œäºæ˜¯å°¤å¸ˆæƒ³äº†ä¸ªæŠ˜ä¸­çš„åŠæ³•ï¼Œæ­£å¥½åˆ©ç”¨ [Esbuild](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fevanw%2Fesbuild) æ¥è¿‘æ— æ•Œçš„æ„å»ºé€Ÿåº¦ï¼Œè®©ä½ åœ¨æ²¡æœ‰æ„ŸçŸ¥çš„æƒ…å†µä¸‹åœ¨å¯åŠ¨çš„æ—¶å€™é¢„å…ˆå¸®ä½ æŠŠ `debounce` æ‰€ç”¨åˆ°çš„æ‰€æœ‰å†…éƒ¨æ¨¡å—å…¨éƒ¨æ‰“åŒ…æˆä¸€ä¸ªä¼ ç»Ÿçš„ `js bundle`ã€‚

`Esbuild` ä½¿ç”¨ Go ç¼–å†™ï¼Œå¹¶ä¸”æ¯”ä»¥ JavaScript ç¼–å†™çš„æ‰“åŒ…å™¨é¢„æ„å»ºä¾èµ–å¿« 10-100 å€ã€‚

åœ¨ `httpServer.listen` å¯åŠ¨å¼€å‘æœåŠ¡å™¨ä¹‹å‰ï¼Œä¼šå…ˆæŠŠè¿™ä¸ªå‡½æ•°åŠ«æŒæ”¹å†™ï¼Œæ”¾å…¥ä¾èµ–é¢„æ„å»ºçš„å‰ç½®æ­¥éª¤ï¼Œ[Vite å¯åŠ¨æœåŠ¡å™¨æºç ](https://github.com/vitejs/vite/blob/main/packages/vite/src/node/server/index.ts)ã€‚

```ts
// server/index.ts
const listen = httpServer.listen.bind(httpServer)
httpServer.listen = (async (port: number, ...args: any[]) => {
  try {
    await container.buildStart({})
    // è¿™é‡Œä¼šè¿›è¡Œä¾èµ–çš„é¢„æ„å»º
    await runOptimize()
  } catch (e) {
    httpServer.emit('error', e)
    return
  }
  return listen(port, ...args)
}) as any
å¤åˆ¶ä»£ç 
```

è€Œ `runOptimize` ç›¸å…³çš„ä»£ç åˆ™åœ¨ [Github optimizer](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvitejs%2Fvite%2Fblob%2Fmain%2Fpackages%2Fvite%2Fsrc%2Fnode%2Foptimizer%2Findex.ts) ä¸­ã€‚

é¦–å…ˆä¼šæ ¹æ®æœ¬æ¬¡è¿è¡Œçš„å…¥å£ï¼Œæ¥æ‰«æå…¶ä¸­çš„ä¾èµ–ï¼š

```ts
let deps: Record<string, string>, missing: Record<string, string>
if (!newDeps) {
  ;({ deps, missing } = await scanImports(config))
}
å¤åˆ¶ä»£ç 
```

`scanImports` å…¶å®å°±æ˜¯åˆ©ç”¨ `Esbuild` æ„å»ºæ—¶æä¾›çš„é’©å­å»æ‰«ææ–‡ä»¶ä¸­çš„ä¾èµ–ï¼Œæ”¶é›†åˆ° `deps` å˜é‡é‡Œï¼Œåœ¨æ‰«æåˆ°å…¥å£æ–‡ä»¶ï¼ˆæ¯”å¦‚ `index.html`ï¼‰ä¸­ä¾èµ–çš„æ¨¡å—åï¼Œå½¢æˆç±»ä¼¼è¿™æ ·çš„ä¾èµ–è·¯å¾„æ•°æ®ç»“æ„ï¼š

```js
{
  "lodash-es": "node_modules/lodash-es"
}
å¤åˆ¶ä»£ç 
```

ä¹‹åå†æ ¹æ®åˆ†æå‡ºæ¥çš„ä¾èµ–ï¼Œä½¿ç”¨ `Esbuild` æŠŠå®ƒä»¬æå‰æ‰“åŒ…æˆå•æ–‡ä»¶çš„ bundleã€‚

```ts
const esbuildService = await ensureService()
await esbuildService.build({
  entryPoints: Object.keys(flatIdDeps),
  bundle: true,
  format: 'esm',
  external: config.optimizeDeps?.exclude,
  logLevel: 'error',
  splitting: true,
  sourcemap: true,
  outdir: cacheDir,
  treeShaking: 'ignore-annotations',
  metafile: esbuildMetaPath,
  define,
  plugins: [esbuildDepPlugin(flatIdDeps, flatIdToExports, config)]
})
å¤åˆ¶ä»£ç 
```

åœ¨æµè§ˆå™¨è¯·æ±‚ç›¸å…³æ¨¡å—æ—¶ï¼Œè¿”å›è¿™ä¸ªé¢„æ„å»ºå¥½çš„æ¨¡å—ã€‚è¿™æ ·ï¼Œå½“æµè§ˆå™¨è¯·æ±‚ `lodash-es` ä¸­çš„ `debounce` æ¨¡å—çš„æ—¶å€™ï¼Œå°±å¯ä»¥ä¿è¯åªå‘ç”Ÿä¸€æ¬¡æ¥å£è¯·æ±‚äº†ã€‚

ä½ å¯ä»¥ç†è§£ä¸ºï¼Œè¿™ä¸€æ­¥å’Œ `Webpack` æ‰€åšçš„æ„å»ºä¸€æ ·ï¼Œåªä¸è¿‡é€Ÿåº¦å¿«äº†å‡ åå€ã€‚

åœ¨é¢„æ„å»ºè¿™ä¸ªæ­¥éª¤ä¸­ï¼Œè¿˜ä¼šå¯¹ `CommonJS` æ¨¡å—è¿›è¡Œåˆ†æï¼Œæ–¹ä¾¿åé¢éœ€è¦ç»Ÿä¸€å¤„ç†æˆæµè§ˆå™¨å¯ä»¥æ‰§è¡Œçš„ `ES Module`ã€‚

## æ’ä»¶æœºåˆ¶

å¾ˆå¤šåŒå­¦æåˆ° Viteï¼Œç¬¬ä¸€ååº”å°±æ˜¯ç”Ÿæ€ä¸å¤Ÿæˆç†Ÿï¼Œå…¶ä»–æ„å»ºå·¥å…·æœ‰é‚£ä¹ˆå¤šçš„ç¬¬ä¸‰æ–¹æ’ä»¶ï¼Œæä¾›äº†å„ç§å„æ ·å¼€ç®±å³ç”¨çš„ä¾¿æ·åŠŸèƒ½ï¼ŒVite éœ€è¦å¤šä¹…æ‰èƒ½èµ¶ä¸Šå‘¢ï¼Ÿ

Vite ä» preact çš„ WMR ä¸­å¾—åˆ°äº†å¯å‘ï¼ŒæŠŠæ’ä»¶æœºåˆ¶åšæˆ**å…¼å®¹ Rollup** çš„æ ¼å¼ã€‚

äºæ˜¯ä¾¿æœ‰äº†è¿™ä¸ª**ç›¸äº²ç›¸çˆ±**çš„ LOGOï¼š

![Vite Rollup Plugins](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ee1321a80d7841e2b4632e20526ff38c~tplv-k3u1fbpfcp-watermark.awebp)

ç›®å‰å’Œ vite å…¼å®¹æˆ–è€…å†…ç½®çš„æ’ä»¶ï¼Œå¯ä»¥æŸ¥çœ‹[vite-rollup-plugins](https://link.juejin.cn?target=https%3A%2F%2Fvite-rollup-plugins.patak.dev%2F)ã€‚

ç®€å•çš„ä»‹ç»ä¸€ä¸‹ Rollup æ’ä»¶ï¼Œå…¶å®æ’ä»¶è¿™ä¸ªä¸œè¥¿ï¼Œå°±æ˜¯ Rollup å¯¹å¤–æä¾›ä¸€äº›æ—¶æœºçš„é’©å­ï¼Œè¿˜æœ‰ä¸€äº›å·¥å…·æ–¹æ³•ï¼Œè®©ç”¨æˆ·å»å†™ä¸€äº›é…ç½®ä»£ç ï¼Œä»¥æ­¤ä»‹å…¥ Rollup è¿è¡Œçš„å„ä¸ªæ—¶æœºä¹‹ä¸­ã€‚

æ¯”å¦‚åœ¨æ‰“åŒ…ä¹‹å‰æ³¨å…¥æŸäº›ä¸œè¥¿ï¼Œæˆ–è€…æ”¹å˜æŸäº›äº§ç‰©ç»“æ„ï¼Œä»…æ­¤è€Œå·²ã€‚

è€Œ Vite éœ€è¦åšçš„å°±æ˜¯åŸºäº Rollup è®¾è®¡çš„æ¥å£è¿›è¡Œæ‰©å±•ï¼Œåœ¨ä¿è¯ Rollup æ’ä»¶å…¼å®¹çš„å¯èƒ½æ€§çš„åŒæ—¶ï¼Œå†åŠ å…¥ä¸€äº› Vite ç‰¹æœ‰çš„é’©å­å’Œå±æ€§æ¥æ‰©å±•ã€‚

ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œ[@rollup/plugin-image](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frollup%2Fplugins%2Fblob%2Fmaster%2Fpackages%2Fimage%2Fsrc%2Findex.js) å¯ä»¥æŠŠå›¾ç‰‡æ¨¡å—è§£ææˆ base64 æ ¼å¼ï¼Œå®ƒçš„æºç å…¶å®å¾ˆç®€å•ï¼š

```ts
export default function image(opts = {}) {
  const options = Object.assign({}, defaults, opts)
  const filter = createFilter(options.include, options.exclude)

  return {
    name: 'image',

    load(id) {
      if (!filter(id)) {
        return null
      }

      const mime = mimeTypes[extname(id)]
      if (!mime) {
        // not an image
        return null
      }

      const isSvg = mime === mimeTypes['.svg']
      const format = isSvg ? 'utf-8' : 'base64'
      const source = readFileSync(id, format).replace(/[\r\n]+/gm, '')
      const dataUri = getDataUri({ format, isSvg, mime, source })
      const code = options.dom
        ? domTemplate({ dataUri })
        : constTemplate({ dataUri })

      return code.trim()
    }
  }
}
å¤åˆ¶ä»£ç 
```

å…¶å®å°±æ˜¯åœ¨ `load` è¿™ä¸ªé’©å­ï¼Œè¯»å–æ¨¡å—æ—¶ï¼ŒæŠŠå›¾ç‰‡è½¬æ¢æˆç›¸åº”æ ¼å¼çš„ `data-uri`ï¼Œæ‰€ä»¥ Vite åªéœ€è¦åœ¨è¯»å–æ¨¡å—çš„æ—¶å€™ï¼Œä¹Ÿå»å…¼å®¹æ‰§è¡Œç›¸å…³çš„é’©å­å³å¯ã€‚

è™½ç„¶ Vite å¾ˆå¤šè¡Œä¸ºå’Œ Rollup æ„å»ºä¸åŒï¼Œä½†ä»–ä»¬å†…éƒ¨æœ‰å¾ˆå¤šç›¸ä¼¼çš„è¡Œä¸ºå’Œæ—¶æœºï¼Œåªè¦ç¡®ä¿ Rollup æ’ä»¶åªä½¿ç”¨äº†è¿™äº›å…±æœ‰çš„é’©å­ï¼Œå°±å¾ˆå®¹æ˜“åšåˆ°æ’ä»¶çš„é€šç”¨ã€‚

å¯ä»¥å‚è€ƒ [Vite å®˜ç½‘æ–‡æ¡£ â€”â€” æ’ä»¶éƒ¨åˆ†](https://link.juejin.cn?target=https%3A%2F%2Fcn.vitejs.dev%2Fguide%2Fapi-plugin.html%23rollup-%E6%8F%92%E4%BB%B6%E5%85%BC%E5%AE%B9%E6%80%A7)

> ä¸€èˆ¬æ¥è¯´ï¼Œåªè¦ä¸€ä¸ª Rollup æ’ä»¶ç¬¦åˆä»¥ä¸‹æ ‡å‡†ï¼Œé‚£ä¹ˆå®ƒåº”è¯¥åªæ˜¯ä½œä¸ºä¸€ä¸ª Vite æ’ä»¶:
>
> - æ²¡æœ‰ä½¿ç”¨ moduleParsed é’©å­ã€‚
> - å®ƒåœ¨æ‰“åŒ…é’©å­å’Œè¾“å‡ºé’©å­ä¹‹é—´æ²¡æœ‰å¾ˆå¼ºçš„è€¦åˆã€‚
> - å¦‚æœä¸€ä¸ª Rollup æ’ä»¶åªåœ¨æ„å»ºé˜¶æ®µæœ‰æ„ä¹‰ï¼Œåˆ™åœ¨ build.rollupOptions.plugins ä¸‹æŒ‡å®šå³å¯ã€‚

Vite åé¢çš„ç›®æ ‡åº”è¯¥ä¹Ÿæ˜¯å°½å¯èƒ½å’Œ Rollup ç›¸å…³çš„æ’ä»¶ç”Ÿæ€æ‰“é€šï¼Œç¤¾åŒºä¹Ÿä¼šä¸€èµ·è´¡çŒ®åŠ›é‡ï¼Œå¸Œæœ› Vite çš„ç”Ÿæ€è¶Šæ¥è¶Šå¥½ã€‚

## æ¯”è¾ƒ

å’Œ Vite åŒæ—¶æœŸå‡ºç°çš„ç°ä»£åŒ–æ„å»ºå·¥å…·è¿˜æœ‰ï¼š

- [Snowpack - The faster frontend build tool](https://link.juejin.cn?target=https%3A%2F%2Fwww.snowpack.dev%2F)
- [preactjs/wmr: ğŸ‘©â€ğŸš€ The tiny all-in-one development tool for modern web apps.](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpreactjs%2Fwmr)
- [Web Dev Server: Modern Web](https://link.juejin.cn?target=https%3A%2F%2Fmodern-web.dev%2Fdocs%2Fdev-server%2Foverview%2F)

### Snowpack

Snowpack å’Œ Vite æ¯”è¾ƒç›¸ä¼¼ï¼Œä¹Ÿæ˜¯åŸºäº ESM æ¥å®ç°å¼€å‘ç¯å¢ƒæ¨¡å—åŠ è½½ï¼Œä½†æ˜¯å®ƒçš„æ„å»ºæ—¶å´æ˜¯äº¤ç»™ç”¨æˆ·è‡ªå·±é€‰æ‹©ï¼Œæ•´ä½“çš„æ‰“åŒ…ä½“éªŒæ˜¾å¾—æœ‰ç‚¹æ”¯ç¦»ç ´ç¢ã€‚

è€Œ Vite ç›´æ¥æ•´åˆäº† Rollupï¼Œä¸ºç”¨æˆ·æä¾›äº†å®Œå–„ã€å¼€ç®±å³ç”¨çš„è§£å†³æ–¹æ¡ˆï¼Œå¹¶ä¸”ç”±äºè¿™äº›é›†æˆï¼Œä¹Ÿæ–¹ä¾¿æ‰©å±•æ›´å¤šçš„é«˜çº§åŠŸèƒ½ã€‚

### WMR

WMR åˆ™æ˜¯ä¸º Preact è€Œç”Ÿçš„ï¼Œå¦‚æœä½ åœ¨ä½¿ç”¨ Preactï¼Œå¯ä»¥ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨è¿™ä¸ªå·¥å…·ã€‚

### @web/dev-server

è¿™ä¸ªå·¥å…·å¹¶æœªæä¾›å¼€ç®±å³ç”¨çš„æ¡†æ¶æ”¯æŒï¼Œä¹Ÿéœ€è¦æ‰‹åŠ¨è®¾ç½® Rollup æ„å»ºé…ç½®ï¼Œä¸è¿‡è¿™ä¸ªé¡¹ç›®é‡ŒåŒ…å«çš„å¾ˆå¤šå·¥å…·ä¹Ÿå¯ä»¥è®© Vite ç”¨æˆ·å—ç›Šã€‚

æ›´å…·ä½“çš„æ¯”è¾ƒå¯ä»¥å‚è€ƒ[Vite æ–‡æ¡£ â€”â€” æ¯”è¾ƒ](https://link.juejin.cn?target=https%3A%2F%2Fcn.vitejs.dev%2Fguide%2Fcomparisons.html)

## æ€»ç»“

Vite æ˜¯ä¸€ä¸ªå……æ»¡é­”åŠ›çš„ç°ä»£åŒ–æ„å»ºå·¥å…·ï¼Œå°¤è€å¸ˆä¹Ÿåœ¨å„ä¸ªå¹³å°æ”¾ä¸‹ç‹ è¯ï¼Œè¯´è¦æ›¿ä»£ Webpackã€‚å…¶å® Webpack åœ¨ä¸Šä¸ªä¸–ä»£ä¹Ÿæ˜¯ä¸€ä¸ªè´¡çŒ®å¾ˆå¤§çš„æ„å»ºå·¥å…·ï¼Œåªæ˜¯ç”±äºæ–°ç‰¹æ€§çš„å‡ºç°ï¼Œæœ‰äº†å¯ä»¥è§£å†³å®ƒçš„è¯Ÿç—…çš„è§£å†³æ–¹æ¡ˆã€‚

ç›®å‰æˆ‘ä¸ªäººè§‰å¾—ï¼Œä¸€äº›è½»å‹çš„é¡¹ç›®ï¼ˆä¸éœ€è¦ä¸€äº›ç‰¹åˆ«å¥‡æ€ªçš„ä¾èµ–æ„å»ºï¼‰å®Œå…¨å¯ä»¥å¼€å§‹å°è¯• Viteï¼Œæ¯”å¦‚ï¼š

- å„ç§æ¡†æ¶ã€åº“ä¸­çš„å±•ç¤º demo é¡¹ç›®ã€‚
- è½»é‡çº§çš„ä¸€äº›ä¼ä¸šé¡¹ç›®ã€‚

ä¹Ÿè¡·å¿ƒç¥ç¦ Vite çš„ç”Ÿæ€è¶Šæ¥è¶Šå¥½ï¼Œå…±åŒè¿æ¥è¿™ä¸ªæ„å»ºçš„æ–°ä¸–ä»£ã€‚

ä¸è¿‡åˆ°é‚£ä¸ªæ—¶å€™ï¼Œæˆ‘å¯èƒ½è¿˜ä¼šæŒºæ€€å¿µä»å‰ Webpack æ€€å¿µæ„å»ºçš„æ—¶å€™ï¼Œé‚£å‡ åˆ†é’Ÿä¸€æœ¬æ­£ç»çš„æ‘¸é±¼æ—¶åˆ» ğŸ˜†ã€‚

ä½œè€…ï¼šssh_æ™¨æ›¦æ—¶æ¢¦è§å…®
é“¾æ¥ï¼šhttps://juejin.cn/post/6932367804108800007
æ¥æºï¼šç¨€åœŸæ˜é‡‘
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚

**4. å°†ç°æœ‰çš„é¡¹ç›®è¿ç§»ä½¿ç”¨Viteå­˜åœ¨å“ªäº›é—®é¢˜**

+ *Svgç»„ä»¶æŠ¥é”™*

â€‹	Vite æš‚æ—¶æ²¡æœ‰å¯¹ svg ç»„ä»¶å†™æ³•çš„æ”¯æŒï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸‹é¢çš„å†™æ³•ä¼šå¯¼è‡´æµè§ˆå™¨æŠ¥é”™:

```js
import Up from 'common/imgs/up.svg';

function Home() {
  return {
    <>
      // çœç•¥å…¶ä»–å­ç»„ä»¶
      <Up className="admin-header-user-up" />
    </>
  }
}

```

è§£å†³æ–¹æ¡ˆ ï¼š ä½¿ç”¨`vite-plugin-react-svg`æ’ä»¶, å°†svgæ·»åŠ åˆ°Viteçš„pluginsæ•°ç»„ä¸­ï¼Œå®ç°äº†ä»¥ç»„ä»¶æ–¹å¼å¼•ç”¨ SVG èµ„æºçš„èƒ½åŠ›

`import Up from 'common/imgs/up.svg?component';`

+ *å¤§é‡ç¬¬ä¸‰æ–¹åŒ…æŠ¥é”™*

